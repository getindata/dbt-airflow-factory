# Project Context

## Purpose
**dbt-airflow-factory** is a Python library that converts dbt (data build tool) manifest metadata into Apache Airflow DAGs. It automates the creation of Airflow workflows from dbt projects, enabling data engineers to orchestrate dbt models, tests, and seeds as Airflow tasks with full dependency management.

### Key Goals:
- Parse `manifest.json` files generated by dbt and automatically create corresponding Airflow DAGs
- Support multiple execution environments (Kubernetes, ECS, Bash) for running dbt commands
- Provide flexible, YAML-based configuration for customizing DAG behavior per environment
- Enable integration with data ingestion tools (Airbyte) alongside dbt transformations
- Support notifications (Slack, MS Teams) for DAG execution status

## Tech Stack
- **Primary Language**: Python 3.8-3.11
- **Core Dependencies**:
  - Apache Airflow 2.5+ (with Kubernetes and Slack providers)
  - dbt-graph-builder 0.7.x (for parsing dbt manifest)
  - apache-airflow-providers-airbyte 3.1+
  - pytimeparse 1.1+
- **Development Tools**:
  - pytest (testing framework)
  - tox (test automation)
  - pre-commit (git hooks)
  - black (code formatter, line length 100)
  - flake8 (linting, max line length 120)
  - isort (import sorting)
  - mypy (static type checking)
- **CI/CD**: GitHub Actions (python-package.yml)
- **Documentation**: Sphinx with RTD theme
- **Distribution**: PyPI package

## Project Conventions

### Code Style
- **Formatter**: Black with 100 character line length (pyproject.toml)
- **Linter**: Flake8 with 120 character max line length, E203 extended ignore
- **Import Sorting**: isort with black profile
- **Type Checking**: mypy with strict settings:
  - `disallow_untyped_defs = True`
  - `check_untyped_defs = True`
  - `no_implicit_optional = True`
  - `warn_redundant_casts = True`
  - Tests directory exempted from type checking
- **Naming Conventions**:
  - Snake_case for functions, variables, and modules
  - PascalCase for classes
  - Private attributes prefixed with underscore (`_builder`)

### Architecture Patterns
- **Factory Pattern**: Extensive use throughout (AirflowDagFactory, DbtAirflowTasksBuilderFactory, IngestionFactory, NotificationHandlersFactory)
- **Builder Pattern**: DbtAirflowTasksBuilder for constructing complex task hierarchies
- **Strategy Pattern**: Multiple operator implementations (K8s, ECS, Bash) with shared interfaces
- **Configuration-Driven Design**: YAML-based configuration system with layered environments (base â†’ env-specific)
- **Separation of Concerns**:
  - `airflow_dag_factory.py`: DAG creation and orchestration
  - `tasks_builder/`: Task and dependency graph construction
  - `k8s/`, `ecs/`, `bash/`: Execution environment implementations
  - `notifications/`: Alert handling
  - `config_utils.py`: Configuration management
- **Parameters Objects**: Dedicated parameter classes for each operator type (K8sParameters, EcsParameters, BashParameters)

### Testing Strategy
- **Framework**: pytest with pytest-cov for coverage reporting
- **Test Organization**: Tests mirror source structure in `tests/` directory
- **Test Fixtures**: Example configuration files in `tests/config/` with multiple scenarios:
  - `base/`: Default configuration baseline
  - `vars/`, `airflow_vars/`: Testing variable interpolation
  - `notifications_slack/`, `no_gateway/`: Feature-specific scenarios
- **Coverage Requirements**: Coverage reports generated for CodeClimate integration
- **Testing Command**: `tox -e py38` (default environment)
- **Pre-commit Testing**: All tests run via pre-commit hooks before commits
- **Mock Data**: Sample `manifest.json` files for testing dbt manifest parsing

### Git Workflow
- **Main Branches**:
  - `main`: Production-ready releases
  - `develop`: Active development (current branch)
- **CI Triggers**:
  - Push to `main` and `develop` branches
  - All pull requests
- **Commit Process**:
  1. Pre-commit hooks automatically run (black, isort, flake8, mypy)
  2. All tests must pass via tox
  3. Coverage reports generated
- **Release Process**:
  - Version bumping via bumpversion (setup.py and __init__.py)
  - GitHub Actions workflows for prepare-release and publish
  - PyPI distribution via twine
- **Version Format**: Semantic versioning (currently 0.35.0)

## Domain Context
- **dbt (data build tool)**: SQL-based transformation tool that generates a `manifest.json` file containing metadata about models, tests, seeds, snapshots, and their dependencies
- **Manifest Structure**: The `manifest.json` contains nodes (models, tests, seeds) with dependency graphs that map to Airflow task dependencies
- **Task Groups**: Airflow feature for visually grouping related tasks (can be toggled via `use_task_group` config)
- **Ephemeral Models**: dbt models that exist only in-memory during transformation (can be shown/hidden in DAG via `show_ephemeral_models`)
- **Execution Environments**:
  - **Kubernetes**: Uses KubernetesPodOperator for containerized dbt execution
  - **ECS**: AWS Elastic Container Service for Fargate-based execution
  - **Bash**: Direct bash command execution for local/simple deployments
- **Seed Tasks**: Special dbt tasks that load CSV data into the warehouse
- **Ingestion Integration**: Pre-dbt tasks for data ingestion from sources (Airbyte supported)
- **Airflow Template Variables**: Support for `{{ var.value.env }}`, `{{ ds_nodash }}` in config files

## Important Constraints
- **Airflow Version Compatibility**: Supports Airflow 2.5-2.x only (uses version detection for DummyOperator import)
- **Python Version Range**: 3.8-3.11 (no 3.12+ support yet)
- **Configuration Format**: Strictly YAML-based, no JSON or TOML configs supported
- **Manifest Location**: Must have access to dbt-generated `manifest.json` at runtime
- **Kubernetes Context**: K8s operator requires cluster access and proper RBAC permissions
- **Airflow Variables**: Only `{{ var.value.VARIABLE_NAME }}` pattern supported in airflow.yml, other template variables work in dbt.yml and k8s.yml
- **Directory Structure**: Expects specific layout with `config/base/` and `config/{env}/` directories
- **Package Distribution**: Must maintain backward compatibility within 0.x version range

## External Dependencies
- **dbt-graph-builder** (0.7.x): Core dependency for parsing dbt manifest.json and building dependency graphs
- **Apache Airflow** (2.5-2.x): Runtime environment and DAG execution engine
- **Apache Airflow Kubernetes Provider**: For K8s-based dbt execution
- **Apache Airflow Airbyte Provider** (3.1+): For data ingestion task integration
- **Kubernetes Cluster**: Required when using K8s execution environment
- **AWS ECS/Fargate**: Required when using ECS execution environment
- **data-pipelines-cli**: Recommended companion tool for directory setup and Docker image management
- **Cloud Storage**: DAGs often stored in GCS/S3 (referenced in config as `dags_path`)
- **Slack/MS Teams APIs**: Optional, for notification integrations
- **CodeClimate**: External service for test coverage reporting (CC_TEST_REPORTER_ID configured)
